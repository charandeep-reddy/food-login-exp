<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cart - Food Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
      <h1 class="text-3xl font-bold text-center mb-8">Order Summary</h1>

      <div class="grid md:grid-cols-2 gap-8">
        <!-- User Information Form -->
        <div class="bg-white p-6 rounded-lg shadow-md">
          <h2 class="text-xl font-semibold mb-4">Delivery Information</h2>
          <form id="orderForm" class="space-y-4">
            <div>
              <label class="block text-gray-700 mb-2">Name *</label>
              <input
                type="text"
                name="name"
                required
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-food-yellow"
              />
            </div>
            <div>
              <label class="block text-gray-700 mb-2">Phone Number *</label>
              <input
                type="tel"
                name="phone"
                pattern="[0-9]{10}"
                required
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-food-yellow"
              />
            </div>
            <div>
              <label class="block text-gray-700 mb-2">Address *</label>
              <textarea
                name="address"
                required
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-food-yellow"
              ></textarea>
            </div>
            <div>
              <label class="block text-gray-700 mb-2">City *</label>
              <input
                type="text"
                name="city"
                required
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-food-yellow"
              />
            </div>
            <div>
              <label class="block text-gray-700 mb-2">Pincode *</label>
              <input
                type="text"
                name="pincode"
                pattern="[0-9]{6}"
                required
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-food-yellow"
              />
            </div>
          </form>
        </div>

        <!-- Cart Summary -->
        <div class="bg-white p-6 rounded-lg shadow-md">
          <h2 class="text-xl font-semibold mb-4">Cart Items</h2>
          <div id="cartItems" class="space-y-4 mb-6">
            <!-- Cart items will be dynamically added here -->
          </div>
          <div class="border-t pt-4">
            <div
              class="flex justify-between items-center text-lg font-semibold mb-6"
            >
              <span>Total:</span>
              <span id="totalPrice">₹0</span>
            </div>
            <button
              onclick="placeOrder()"
              class="w-full bg-food-yellow text-white py-3 rounded-lg font-semibold hover:bg-yellow-500 transition"
            >
              Place Order
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Load cart items from localStorage on page load
      document.addEventListener("DOMContentLoaded", function () {
        const cartItems = document.getElementById("cartItems");
        const cart = JSON.parse(localStorage.getItem("cart") || "{}");
        let total = 0;

        Object.entries(cart).forEach(([key, quantity]) => {
          const [itemName, weight] = key.split("-");
          const price = JSON.parse(localStorage.getItem("prices"))[key] || 0;
          const itemTotal = price * quantity;
          total += itemTotal;

          const itemElement = document.createElement("div");
          itemElement.className =
            "flex justify-between items-center border-b pb-4";
          itemElement.innerHTML = `
                    <div>
                        <p class="font-medium">${itemName}</p>
                        ${
                          weight !== "Single"
                            ? `<p class="text-sm text-gray-600">${weight}</p>`
                            : ""
                        }
                        <p class="text-sm">₹${price} x ${quantity}</p>
                    </div>
                    <p class="font-semibold">₹${itemTotal}</p>
                `;
          cartItems.appendChild(itemElement);
        });

        document.getElementById("totalPrice").textContent = `₹${total}`;
      });

      async function placeOrder() {
        const form = document.getElementById("orderForm");
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const formData = new FormData(form);
        const cart = JSON.parse(localStorage.getItem("cart") || "{}");
        const prices = JSON.parse(localStorage.getItem("prices") || "{}");

        const cartItems = Object.entries(cart).map(([key, qty]) => {
          const [name, weight] = key.split("-");
          return {
            name,
            weight: weight === "Single" ? undefined : weight,
            qty,
            price: prices[key] * qty,
          };
        });

        const total = cartItems.reduce((sum, item) => sum + item.price, 0);

        const orderData = {
          name: formData.get("name"),
          phone: formData.get("phone"),
          address: formData.get("address"),
          city: formData.get("city"),
          pincode: formData.get("pincode"),
          cartItems,
          total,
        };

        try {
          const response = await fetch("/place-order", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(orderData),
          });

          if (response.ok) {
            // Clear cart and redirect to confirmation page
            localStorage.removeItem("cart");
            localStorage.removeItem("prices");
            alert("Order placed successfully!");
            window.location.href = "/";
          } else {
            throw new Error("Failed to place order");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Failed to place order. Please try again.");
        }
      }
    </script>
  </body>
</html>
